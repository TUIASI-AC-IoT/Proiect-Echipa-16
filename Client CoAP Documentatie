Documentatie Client CoAP

 1. Scopul proiectului
Scopul acestui proiect este implementarea unui client CoAP (Constrained Application Protocol) care permite trimiterea si accesarea unor documente de mic dimensiuni într-o arhitectură de tip remote storage.
Protocolul CoAP este conceput pentru sisteme cu resurse limitate (dispozitive IoT, senzori, microcontrolere), fiind o alternativă ușoară la HTTP, bazată pe UDP.
Clientul implementat oferă o serie de funcționalități printre care se numără:
	-încărcarea și descărcarea fișierelor,
	-crearea și ștergerea acestora,
	-navigarea în structura de directoare,
	-mutarea fișierelor între directoare
	-implementarea unei interfete prietenoase.
Comunicarea între client și server se face exclusiv prin mesaje CoAP, transmise prin socket-uri UDP.

2.Formatul pachetelor
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |Ver| T |  TKL  |      Code     |          Message ID           |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |   Token (if any, TKL bytes) ...
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |   Options (if any) ...
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |1 1 1 1 1 1 1 1|    Payload (if any) ...
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
Header:
	-este alcătuit din 4 octeți
Token:
	-rolul token-ului este acela de a corela cererile cu răspunsurile. Astfel, cererea
respectiv răspunsul primit vor avea același token.
Options:
	-conțin informații suplimentare despre mesaj, cum ar fi tipul de conținut, calea resursei, dimensiunea datelor sau parametri specifici aplicației.
Payload:
	-aici este situat mesajul propriu-zis

Pachete proprietare (pentru aplicație)
Tip				Descriere			Conținut Payload
FILE_UPLOAD		Client → Server		Header CoAP (POST) + nume fișier + conținut fișier
FILE_DOWNLOAD	Client → Server		Header CoAP (GET) + calea fișierului
FILE_DELETE		Client → Server		Header CoAP (DELETE) + calea fișierului
FILE_MOVE		Client → Server		Header CoAP (CUSTOM/MOVE) + calea sursă + calea destinație
DIR_LIST		Client → Server		Header CoAP (GET) + calea directorului

3.Transmiterea mesajelor

În cadrul CoAP există 4 tipuri de mesaje: Confirmable (CON),Non-confirmable (NON), Acknowledge (ACK) și Reset (RST):
A. Confirmable (CON):
	- este trimis până la primirea unui mesaj de tipul ACK sau RST;
	- cere trimiterea unui mesaj de tipul ACK sau RST, acestea din urmă trebuind să aibă același ID.
B. Non-confirmable (NON):
	- trimiterea lui nu necesită un mesaj de tip ACK sau RST.
C. Acknowledge (ACK):
	- nu indică succesul sau reușita unei cereri, arată doar faptul că cererea a ajuns la endpoint.
D. Reset (RST):
	- indică primirea unei cereri (CON sau NON) dar anumite detalii necesare lipsesc.

4.Operatiuni specifice CoAP si interactiunea intre server-client
-Upload fișier (POST /upload)
	Client trimite pachet Confirmable cu cod 0.02 (POST)
	Server salvează fișierul → trimite ACK 2.01 Created
	Payload: [path] + [file content]
	client:
	{
	  "path": "/directory/file.txt",
	  "content": "Data"
	}
	Server:
	{
	  "status": "created",
	  "path": "/directory/file.txt",
	  "size": 1024
	}
	{
	  "status": "error",
	  "message": "Unable to execute"
	}

-Download fișier (GET /download)
	Client trimite GET cu calea fișierului
	Server trimite ACK 2.05 Content + payload cu fișierul
	Client:
	{
	  "path": "/directory/file.txt"
	}
		server:
	{
	  "name": "file.txt",
	  "size": 2048,
	  "content": "Data"
	}
	
	{
	  "status": "error",
	  "message": "Unable to execute"
	}

-Ștergere fișier (DELETE /path)
	Client → Confirmable cod 0.04 (DELETE)
	Server → ACK 2.02 Deleted
	Client:
	{
	  "path": "/directory/file.txt"
	}
	Server:
	{
	  "status": "deleted",
	  "path": "/directory/file.txt"
	}
	{
	  "status": "error",
	  "message": "Unable to execute"
	}

-Mutare fișier (MOVE /src /dst) 
	Client → Confirmable cod 0.08 (MOVE)
	Server → ACK 2.01 Created dacă mutarea a reușit
	client:
	{
	  "source": "/directory/file_1.txt",
	  "destination": "/directory2/file_1.txt"
	}
	server:
	{
	  "status": "moved",
	  "from": "/directory/file_1.txt",
	  "to": "/directory2/file_1.txt"
	}
	{
	  "status": "error",
	  "message": "Unable to execute"
	}

-Listare directoare (GET /list)
	Client → GET pe director
	Server → 2.05 Content cu payload (nume fișiere/directoare)
	client:
	{
	  "name": "directory",
	  "type": "directory",
	  "items": ["file.txt", "file.pdf", "directory2/"]
	}
	Server:
	{
	  "path": "/directory/"
	}
	{
	  "status": "error",
	  "message": "Unable to execute"
	}


5.Threading si modelare aplicatie

Clientul CoAP foloseste protocolul UDP si modulul socket
	
Main Thread ( UI )
|
|
—> Utilizatorul inițiază o cerere (ex: GET )
|
|—> Thread de Pregatire Cerere
   |
   |—> Identifică metoda și resursa
   |—> Dacă e nevoie (POST):
   |  |
   |  |—> Thread pentru fișiere 
   |  |   |
   |  |   —> Citește datele (payload) dintr-un fișier local
   |
   |—> Thread de Trimitere și Răspuns
       |
       |—> Formează pachetul UDP 
       |—> Trimite pachetul UDP la server
       |
       |—> Așteaptă răspunsul de la server 
       |
       |—> Răspuns primit!
       |
       |—> Decodifică pachetul de răspuns (ex: 2.05 Content)
|
|
—> Main Thread continuă 

6.Exemplu aplicatie
Exemplu al metodei GET cu ACK din partea serverului
Client  Server
      |      |
      |      |
      +----->|     Header: GET (T=CON, Code=0.01, MID)
      | GET  |   Uri-Path: "temperature"
      |      |
      |      |
      |<-----+     Header: 2.05 Content (T=ACK, Code=2.05, MID)
      | 2.05 |    Payload: "22.3 C"
      |      |

6.Bibliografie

https://docs.streamsets.com/platform-datacollector/latest/datacollector/UserGuide/Destinations/CoAPClient.html#concept_fcy_cj4_sz
https://datatracker.ietf.org/doc/html/rfc7252#section-2.2
https://en.wikipedia.org/wiki/Constrained_Application_Protocol

